<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 7.0.1 and Furo 2023.05.20 -->
        <title>pytb.tb - ThunderBoltz 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=e6660623a769aa55fea372102b9bf3151b292993" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">ThunderBoltz 0.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">ThunderBoltz 0.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">ThunderBoltz 0.1 Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cs_guide.html">Preparing Cross Sections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../multi_guide.html">Running Multiple Calculations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ext_guide.html">Extracting Results</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../bm.html">Benchmark Testing</a></li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../params.html">Simulation Parameters</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Simulation Parameters</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pytb.parameters.TBParameters.html">pytb.parameters.TBParameters</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of pytb.parameters.TBParameters</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parameters.TBParameters.get_params.html">pytb.parameters.TBParameters.get_params</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pytb.parameters.WrapParameters.html">pytb.parameters.WrapParameters</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of pytb.parameters.WrapParameters</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parameters.WrapParameters.get_params.html">pytb.parameters.WrapParameters.get_params</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pytb.parameters.OutputParameters.html">pytb.parameters.OutputParameters</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of pytb.parameters.OutputParameters</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parameters.OutputParameters.get_params.html">pytb.parameters.OutputParameters.get_params</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pytb.parameters.ParticleParameters.html">pytb.parameters.ParticleParameters</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of pytb.parameters.ParticleParameters</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parameters.ParticleParameters.get_params.html">pytb.parameters.ParticleParameters.get_params</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../ref.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pytb.ThunderBoltz.html">pytb.ThunderBoltz</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of pytb.ThunderBoltz</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.add_callback.html">pytb.ThunderBoltz.add_callback</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.compile_debug.html">pytb.ThunderBoltz.compile_debug</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.compile_from.html">pytb.ThunderBoltz.compile_from</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.describe_dist.html">pytb.ThunderBoltz.describe_dist</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.get_directory.html">pytb.ThunderBoltz.get_directory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.get_edfs.html">pytb.ThunderBoltz.get_edfs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.get_etrans.html">pytb.ThunderBoltz.get_etrans</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.get_particle_tables.html">pytb.ThunderBoltz.get_particle_tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.get_sim_param.html">pytb.ThunderBoltz.get_sim_param</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.get_ss_params.html">pytb.ThunderBoltz.get_ss_params</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.get_timeseries.html">pytb.ThunderBoltz.get_timeseries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.get_vdfs.html">pytb.ThunderBoltz.get_vdfs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.plot_cs.html">pytb.ThunderBoltz.plot_cs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.plot_edf_comps.html">pytb.ThunderBoltz.plot_edf_comps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.plot_edfs.html">pytb.ThunderBoltz.plot_edfs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.plot_rates.html">pytb.ThunderBoltz.plot_rates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.plot_timeseries.html">pytb.ThunderBoltz.plot_timeseries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.plot_vdfs.html">pytb.ThunderBoltz.plot_vdfs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.read.html">pytb.ThunderBoltz.read</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.read_log.html">pytb.ThunderBoltz.read_log</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.read_particle_table.html">pytb.ThunderBoltz.read_particle_table</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.read_stdout.html">pytb.ThunderBoltz.read_stdout</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.read_tb_params.html">pytb.ThunderBoltz.read_tb_params</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.reset.html">pytb.ThunderBoltz.reset</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.run.html">pytb.ThunderBoltz.run</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.set_.html">pytb.ThunderBoltz.set_</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.set_fixed_tracking.html">pytb.ThunderBoltz.set_fixed_tracking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.set_ts_plot_params.html">pytb.ThunderBoltz.set_ts_plot_params</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.to_pickleable.html">pytb.ThunderBoltz.to_pickleable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.ThunderBoltz.write_input.html">pytb.ThunderBoltz.write_input</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/pytb.tb.read.html">pytb.tb.read</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/pytb.tb.query_tree.html">pytb.tb.query_tree</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/pytb.tb.CrossSections.from_LXCat.html">pytb.tb.CrossSections.from_LXCat</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pytb.CrossSections.html">pytb.CrossSections</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of pytb.CrossSections</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.CrossSections.add_differential_model.html">pytb.CrossSections.add_differential_model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.CrossSections.add_process.html">pytb.CrossSections.add_process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.CrossSections.add_processes.html">pytb.CrossSections.add_processes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.CrossSections.find_infile.html">pytb.CrossSections.find_infile</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.CrossSections.from_LXCat.html">pytb.CrossSections.from_LXCat</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.CrossSections.get_deck.html">pytb.CrossSections.get_deck</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.CrossSections.plot_cs.html">pytb.CrossSections.plot_cs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.CrossSections.read.html">pytb.CrossSections.read</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.CrossSections.set_fixed_background.html">pytb.CrossSections.set_fixed_background</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.CrossSections.write.html">pytb.CrossSections.write</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pytb.Process.html">pytb.Process</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of pytb.Process</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.Process.add_differential_parameters.html">pytb.Process.add_differential_parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.Process.auto_sample.html">pytb.Process.auto_sample</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.Process.require_cs.html">pytb.Process.require_cs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.Process.sample_cs.html">pytb.Process.sample_cs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.Process.to_cs_frame.html">pytb.Process.to_cs_frame</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.Process.to_df.html">pytb.Process.to_df</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.Process.zero_below_thresh.html">pytb.Process.zero_below_thresh</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/pytb.input.He_TB.html">pytb.input.He_TB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/pytb.input.convert.html">pytb.input.convert</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pytb.parallel.MPRunner.html">pytb.parallel.MPRunner</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of pytb.parallel.MPRunner</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.MPRunner.get_directory.html">pytb.parallel.MPRunner.get_directory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.MPRunner.run.html">pytb.parallel.MPRunner.run</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.MPRunner.set_.html">pytb.parallel.MPRunner.set_</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.MPRunner.to_pickleable.html">pytb.parallel.MPRunner.to_pickleable</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pytb.parallel.DistributedPool.html">pytb.parallel.DistributedPool</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of pytb.parallel.DistributedPool</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.DistributedPool.err_callback.html">pytb.parallel.DistributedPool.err_callback</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.DistributedPool.submit.html">pytb.parallel.DistributedPool.submit</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pytb.parallel.SlurmManager.html">pytb.parallel.SlurmManager</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of pytb.parallel.SlurmManager</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.SlurmManager.batch_script.html">pytb.parallel.SlurmManager.batch_script</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.SlurmManager.has_active.html">pytb.parallel.SlurmManager.has_active</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.SlurmManager.has_pending.html">pytb.parallel.SlurmManager.has_pending</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.SlurmManager.join.html">pytb.parallel.SlurmManager.join</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.SlurmManager.mock_run.html">pytb.parallel.SlurmManager.mock_run</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.SlurmManager.process_batch_script.html">pytb.parallel.SlurmManager.process_batch_script</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.SlurmManager.sbatch.html">pytb.parallel.SlurmManager.sbatch</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.SlurmManager.set_.html">pytb.parallel.SlurmManager.set_</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.SlurmManager.submit.html">pytb.parallel.SlurmManager.submit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pytb.parallel.SlurmManager.write_slurm_script.html">pytb.parallel.SlurmManager.write_slurm_script</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for pytb.tb</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;The main ThunderBoltz wrapper object with relevant helper functions.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>  <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">listdir</span> <span class="k">as</span> <span class="n">ls</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">pjoin</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">PIPE</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">linregress</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quadrature</span> <span class="k">as</span> <span class="n">quad</span>

<span class="kn">import</span> <span class="nn">pytb</span>
<span class="kn">from</span> <span class="nn">pytb.input</span> <span class="kn">import</span> <span class="n">CrossSections</span>
<span class="kn">from</span> <span class="nn">pytb</span> <span class="kn">import</span> <span class="n">parameters</span>
<span class="kn">from</span> <span class="nn">pytb.parameters</span> <span class="kn">import</span> <span class="n">tb_parameters</span>
<span class="kn">from</span> <span class="nn">pytb.parameters</span> <span class="kn">import</span> <span class="n">wrap_parameters</span>
<span class="kn">from</span> <span class="nn">pytb</span> <span class="kn">import</span> <span class="n">parsing</span>
<span class="kn">from</span> <span class="nn">pytb.parallel</span> <span class="kn">import</span> <span class="n">MPRunner</span>
<span class="kn">from</span> <span class="nn">pytb.parallel</span> <span class="kn">import</span> <span class="n">visit</span>
<span class="kn">from</span> <span class="nn">pytb.plotting.figure_gen</span> <span class="kn">import</span> <span class="n">plot_timeseries</span>
<span class="kn">from</span> <span class="nn">pytb.plotting.figure_gen</span> <span class="kn">import</span> <span class="n">plot_vdfs</span>

<span class="c1"># Physical Constants</span>
<span class="n">ME</span> <span class="o">=</span> <span class="mf">9.1093837e-31</span> <span class="c1"># kg</span>
<span class="n">QE</span> <span class="o">=</span> <span class="mf">1.60217663e-19</span> <span class="c1"># C or J/eV</span>
<span class="n">AMU_TO_KG</span> <span class="o">=</span> <span class="mf">1.6605e-27</span> <span class="c1"># kg / amu</span>

<span class="c1"># Elastic angular distribution function names and parameters</span>
<span class="n">EADF</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;He_Park&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Park&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.283</span><span class="p">,</span> <span class="mf">0.667</span><span class="p">,</span> <span class="mf">0.0307</span><span class="p">,</span> <span class="mf">16.971</span><span class="p">,</span> <span class="mf">6.59</span><span class="p">,</span> <span class="mf">29.02</span><span class="p">,</span> <span class="mf">0.0258</span><span class="p">,</span> <span class="mf">0.295</span><span class="p">,</span> <span class="mf">0.00328</span><span class="p">,</span> <span class="mf">1.794</span><span class="p">]),</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)}</span>

<span class="c1"># Electron impact ionization energy sharing distribution function names and parameters</span>
<span class="n">EESD</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;equal&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Equal&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;uniform&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Uniform&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)}</span>

<span class="c1"># Parameters specifically intended for cross section set construction</span>
<span class="n">CS_PARAMS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;analytic_cs&quot;</span><span class="p">,</span> <span class="s2">&quot;proper_sample&quot;</span><span class="p">,</span> <span class="s2">&quot;nsamples&quot;</span><span class="p">,</span> <span class="s2">&quot;egen&quot;</span><span class="p">,</span>
             <span class="s2">&quot;mix_thresh&quot;</span><span class="p">,</span> <span class="s2">&quot;eadf&quot;</span><span class="p">,</span> <span class="s2">&quot;ECS&quot;</span><span class="p">,</span> <span class="s2">&quot;fixed_background&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="ThunderBoltz"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.html#pytb.ThunderBoltz">[docs]</a><span class="k">class</span> <span class="nc">ThunderBoltz</span><span class="p">(</span><span class="n">MPRunner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ThunderBoltz 0D DSMC simulation wrapper.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory (str): The path to a directory that will host</span>
<span class="sd">            ThunderBoltz compiled, source, input, and output files.</span>
<span class="sd">        cs (CrossSections): The set of cross section information</span>
<span class="sd">            required for this simulation. Optionally supplied as an alternative</span>
<span class="sd">            to ``indeck``, default is an empty CrossSections object.</span>
<span class="sd">        out_file (str): Optional file base name for ThunderBoltz stdout buffer,</span>
<span class="sd">            default is ``&quot;thunderboltz&quot;``.</span>
<span class="sd">        monitor (bool): Runtime flag, when set to ``True`` an empty ``monitor``</span>
<span class="sd">            file will be generated in the simulation directory.</span>
<span class="sd">            Deleting this file will cause the ThunderBoltz process to exit,</span>
<span class="sd">            but allow the wrapper to continue execution. This is useful</span>
<span class="sd">            performing several simulation calculations sequentially,</span>
<span class="sd">            but manual exit is required for each one, or if post processing</span>
<span class="sd">            is required immediately after ThunderBoltz exits.</span>
<span class="sd">        live (bool): Run and update time series plotting GUI during simulation.</span>
<span class="sd">        ts_plot_params (list[str]): The default output parameters to be plotted</span>
<span class="sd">            by :func:`plot_timeseries`.</span>
<span class="sd">        **params:</span>
<span class="sd">            pytb and ThunderBoltz simulation parameters. Any attributes of</span>
<span class="sd">            :class:`~.pytb.parameters.TBParameters` or</span>
<span class="sd">            :class:`~.pytb.parameters.WrapParameters` can be passed here.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#: Name of the simulation output file produced by ``pytb``</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="s2">&quot;thunderboltz.log&quot;</span>
    <span class="c1">#: Files to be read when tabular data is requested</span>
    <span class="n">output_files</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;thunderboltz.out&quot;</span><span class="p">,</span> <span class="s2">&quot;Particle_Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Counts.dat&quot;</span><span class="p">,</span> <span class="n">logfile</span><span class="p">]</span>
    <span class="c1">#: Time series plot parameters</span>
    <span class="n">ts_plot_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MEe&quot;</span><span class="p">,</span> <span class="s2">&quot;mobN&quot;</span><span class="p">,</span> <span class="s2">&quot;a_n&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">monitor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">live</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">live_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ts_plot_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the ThunderBoltz object.&quot;&quot;&quot;</span>
        <span class="c1"># Initialize data structures</span>
        <span class="c1">#: Particle-specific times series data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_tables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kinetic_table</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#: Banner output data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#: All tick-by-tick simulation data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#: Particle velocity dump data</span>
        <span class="c1">#: Particle velocity data intended for particle initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vdf_init_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#: Time step at which steady-state calculations are considered converged</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_conv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#: pd.DataFrame: Table of collision counts</span>
        <span class="c1"># Initialize runtime logging params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_time</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#: Elapsed wall-clock time of calculation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_start</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#: Date/Time of calculation start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_end</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#: Date/Time of calculation end</span>
        <span class="c1"># Initialize runtime params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="n">out_file</span> <span class="c1">#: Name for ThunderBoltz stdout file</span>

        <span class="c1"># Plotting objects and settings</span>
        <span class="c1">#: (bool): Run and update time series plotting GUI during simulation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">live</span> <span class="o">=</span> <span class="n">live</span>
        <span class="c1">#: (bool): Run and update reaction rate plotting GUI during simulation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">live_rate</span> <span class="o">=</span> <span class="n">live_rate</span>
        <span class="c1">#: The figure object for the time series plot.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_fig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#: The figure object for the rate plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_fig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#: List of functions that are called every time banner output is</span>
        <span class="c1">#: updated.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span> <span class="c1">#: Simulation directory</span>
        <span class="c1">#: Recorded thunderboltz warnings read in from output files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ts_plot_params</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_plot_params</span> <span class="o">=</span> <span class="n">ts_plot_params</span>

        <span class="c1"># The Popen subprocess that will execute ThunderBoltz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#: (bool): Option to create temp file during run that causes safe exit upon deletion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>

        <span class="c1"># Grab hyper param defaults</span>
        <span class="n">all_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">wrap_parameters</span><span class="p">)</span>
        <span class="c1"># Update with default thunderboltz params</span>
        <span class="n">all_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">tb_parameters</span><span class="p">))</span>
        <span class="c1"># Update with user initialized thunderboltz params</span>
        <span class="n">all_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="c1"># Remember initial init parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="c1"># Make empty CrossSections object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs</span>
        <span class="k">if</span> <span class="n">cs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">CrossSections</span><span class="p">()</span>
        <span class="c1"># Set input for the first time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_</span><span class="p">(</span><span class="o">**</span><span class="n">all_params</span><span class="p">)</span>

<div class="viewcode-block" id="ThunderBoltz.set_"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.set_.html#pytb.ThunderBoltz.set_">[docs]</a>    <span class="k">def</span> <span class="nf">set_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">p</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update parameters, call appropriate functions ensuring</span>
<span class="sd">        input parameters are self-consistent.</span>

<span class="sd">        Args:</span>
<span class="sd">            **p: Optional keyword parameters to update the calculator.</span>
<span class="sd">                can be any of :class:`~.pytb.parameters.TBParameters` or</span>
<span class="sd">                :class:`~.pytb.parameters.WrapParameters`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set thunderboltz and hyper params appropriately</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">wrap_parameters</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tb_parameters</span><span class="p">})</span>
        <span class="c1"># For now, also allow arbitrary parameters for log files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tb_parameters</span><span class="p">})</span>
        <span class="c1"># Update directory</span>
        <span class="k">if</span> <span class="s2">&quot;directory&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;directory&quot;</span><span class="p">]</span>

        <span class="c1"># Determine if special parameters changed</span>
        <span class="n">resample</span> <span class="o">=</span> <span class="n">CS_PARAMS</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;indeck&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">resample</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_indeck</span><span class="p">()</span>

        <span class="c1"># Adjust differential models if necessary</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;eesd&quot;</span> <span class="ow">in</span> <span class="n">p</span> <span class="ow">or</span> <span class="s2">&quot;eadf&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">table</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_differential_models</span><span class="p">()</span>

        <span class="c1"># No matter what, input files should be considered unwritten</span>
        <span class="c1"># and input re-constrained</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">written_input</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constrain_input</span><span class="p">()</span>

        <span class="c1"># Interpret velocity init file request (must occur after NP is set)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;vdf_init&quot;</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_vdf_init</span><span class="p">()</span></div>

<div class="viewcode-block" id="ThunderBoltz.reset"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.reset.html#pytb.ThunderBoltz.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset output data for a new run.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_tables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kinetic_table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vdf_init_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_conv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_end</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_fig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate_fig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ThunderBoltz.get_sim_param"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.get_sim_param.html#pytb.ThunderBoltz.get_sim_param">[docs]</a>    <span class="k">def</span> <span class="nf">get_sim_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the value of a simulation parameter.</span>

<span class="sd">        Raises:</span>
<span class="sd">            IndexError: if the parameter is not set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># If not found, raise error</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; not a set simulation parameter.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThunderBoltz.read_tb_params"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.read_tb_params.html#pytb.ThunderBoltz.read_tb_params">[docs]</a>    <span class="k">def</span> <span class="nf">read_tb_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Takes file name of an input deck, updates the simulation</span>
<span class="sd">        parameters and returns the simulation parameters which were</span>
<span class="sd">        read from the file ``fname``.</span>

<span class="sd">        Args:</span>
<span class="sd">            fname (str): The name of the indeck file to read.</span>
<span class="sd">            ignore (list[str]): Don&#39;t read certain ThunderBoltz</span>
<span class="sd">                params, e.g. ``[&quot;MP&quot;, &quot;QP&quot;]`` would ignore the</span>
<span class="sd">                mass and charge parameters in an indeck file.</span>
<span class="sd">        Returns:</span>
<span class="sd">            dict: ``tb_params``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Read the input file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="c1"># Drop lines in ignore, comments, and the cross section info table</span>
        <span class="c1"># and form parameter key, value pairs in tuples. Keys may repeat at</span>
        <span class="c1"># this point</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore</span><span class="o">+</span><span class="p">[</span><span class="s2">&quot;CC&quot;</span><span class="p">,</span> <span class="s2">&quot;CS&quot;</span><span class="p">]]</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore</span><span class="o">+</span><span class="p">[</span><span class="s2">&quot;CC&quot;</span><span class="p">,</span> <span class="s2">&quot;CS&quot;</span><span class="p">]]</span>

        <span class="c1"># Consolidate the values of repeated keys into a list of lists lines</span>
        <span class="n">multi_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">keys</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">multi_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span> <span class="k">if</span> <span class="n">keys</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">tb_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">multi_keys</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">mk</span><span class="p">,</span> <span class="n">mv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">multi_keys</span><span class="p">,</span> <span class="n">multi_vals</span><span class="p">):</span>
            <span class="n">tb_params</span><span class="p">[</span><span class="n">mk</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">infer_param_type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mv</span><span class="p">])</span>

        <span class="c1"># Add the rest of the keys</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">multi_keys</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">tb_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">infer_param_type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">tb_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tb_params</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tb_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tb_params</span></div>

    <span class="k">def</span> <span class="nf">_prepare_vdf_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Infer type of vdf_init request and populate vdf_init_data</span>
<span class="sd">        accordingly.&quot;&quot;&quot;</span>
        <span class="c1"># Create directory to store simulation veloctity init data.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;velocity_init&quot;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Convert to a list of each particle type</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;vdf_init&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;vdf_init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;vdf_init&quot;</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vdf_init_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="p">[</span><span class="s2">&quot;LV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vdf_info</span><span class="p">,</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;vdf_init&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdf_info</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="c1"># Interpret as step</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">vdf_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_available_vdfs</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Requested vdf_init step not available&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_vdfs</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="n">vdf_info</span><span class="p">,</span> <span class="n">particle_type</span><span class="o">=</span><span class="n">ptype</span><span class="p">,</span> <span class="n">sample_cap</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vdf_init_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="n">vdf_info</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="n">ptype</span><span class="p">,</span>
                <span class="p">])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdf_info</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># Interpret as path to vdf file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vdf_init_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">parsing</span><span class="o">.</span><span class="n">extract_vdf</span><span class="p">(</span><span class="n">vdf_info</span><span class="p">,</span> <span class="n">sample_cap</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                    <span class="n">ptype</span><span class="p">,</span>
                <span class="p">])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdf_info</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vdf_init_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">vdf_info</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">ptype</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdf_info</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vdf_info</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vdf_init_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vdf_info</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">]),</span>
                    <span class="n">ptype</span><span class="p">,</span>
                <span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;downsample&quot;</span><span class="p">]:</span>
                <span class="c1"># Truncate init data to match NP</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vdf_init_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vdf_init_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">][</span><span class="n">ptype</span><span class="p">],:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="p">)</span>

            <span class="c1"># Add requests to tb input deck</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="s2">&quot;velocity_init&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ParticleType</span><span class="si">{</span><span class="n">ptype</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="p">[</span><span class="s2">&quot;LV&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fname</span><span class="p">,</span> <span class="n">ptype</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">_load_indeck</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample and data from indeck options if available.&quot;&quot;&quot;</span>
        <span class="n">indeck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;indeck&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">indeck</span><span class="p">):</span>
            <span class="c1"># Auto generate CS and indeck with function `indeck`</span>
            <span class="c1"># and these parameters</span>
            <span class="n">csps</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CS_PARAMS</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="p">,</span> <span class="n">tbp</span> <span class="o">=</span> <span class="n">indeck</span><span class="p">(</span><span class="o">**</span><span class="n">csps</span><span class="p">)</span>
            <span class="c1"># Ignore user specified params</span>
            <span class="n">tb_updates</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tbp</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_params</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tb_updates</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">indeck</span><span class="p">:</span>
            <span class="c1"># Interpret as path to pre-written input data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">CrossSections</span><span class="p">(</span><span class="n">input_path</span><span class="o">=</span><span class="n">indeck</span><span class="p">,</span> <span class="n">read_cs_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Ignore init params set by user</span>
            <span class="n">ignored</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_tb_params</span><span class="p">(</span>
                    <span class="n">pjoin</span><span class="p">(</span><span class="n">indeck</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">input_fname</span><span class="p">),</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignored</span><span class="p">)</span>
        <span class="c1"># Otherwise, don&#39;t configure indeck data</span>

    <span class="k">def</span> <span class="nf">_update_differential_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update cross section process tables with parameters.&quot;&quot;&quot;</span>
        <span class="c1"># Elastic</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">EADF</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;eadf&quot;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">msk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">rtype</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;Elastic&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">msk</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;model_name&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="c1"># Ionization</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">EESD</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;eesd&quot;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">msk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">rtype</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;Ionization&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">msk</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;model_name&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_impose_nprod_crit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Minimum requirement for the product of each species particle count.&quot;&quot;&quot;</span>
        <span class="c1"># Aliases</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span>
        <span class="n">hp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span>
        <span class="c1"># Use some defaults if not defined</span>
        <span class="k">if</span> <span class="s2">&quot;DE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hp</span><span class="p">:</span>
            <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;DE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># eV</span>
        <span class="k">if</span> <span class="s2">&quot;EP_0&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hp</span><span class="p">:</span>
            <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;EP_0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.</span>
        <span class="k">if</span> <span class="s2">&quot;Nmin&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hp</span><span class="p">:</span> <span class="c1"># Npairs multiplier (&gt;=1)</span>
            <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;CSTR_P&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="c1"># Reduced mass (kg)</span>
        <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span> <span class="o">=</span> <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;MP&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;MP&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">m1</span><span class="o">*</span><span class="n">m2</span><span class="o">/</span><span class="p">(</span><span class="n">m1</span><span class="o">+</span><span class="n">m2</span><span class="p">)</span> <span class="o">*</span> <span class="n">AMU_TO_KG</span> <span class="c1"># amu to kg</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;L&quot;</span> <span class="ow">in</span> <span class="n">tb</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;no L specified for DT calculation&quot;</span><span class="p">)</span>

        <span class="n">cs_sets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">data</span>
        <span class="n">cs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="c1"># Collect all cross sections into one data frame.</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">df_</span> <span class="ow">in</span> <span class="n">cs_sets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
            <span class="c1"># Calculate vsig(eps) for each cs</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;vsig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">e</span><span class="o">*</span><span class="n">QE</span><span class="o">/</span><span class="n">mu</span><span class="p">)</span><span class="o">*</span><span class="n">cs</span>
            <span class="n">cs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">cs_df</span><span class="p">,</span> <span class="n">df</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">vsig_min_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cs_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;rtype&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">vsig</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">))</span>
        <span class="n">vsig_sum_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cs_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;rtype&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">vsig</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">))</span>
        <span class="c1"># Convert reduced field to Vm^2</span>
        <span class="n">EoN</span> <span class="o">=</span> <span class="mf">1e-21</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;Ered&quot;</span><span class="p">]</span>
        <span class="c1"># Condition: only accelerate EP_0 electrons a max of DE each step</span>
        <span class="n">Ne</span> <span class="o">=</span> <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;Nmin&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">QE</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;EP_0&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">ME</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">QE</span><span class="o">*</span><span class="n">EoN</span><span class="o">/</span><span class="p">(</span><span class="n">QE</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;DE&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">vsig_min_max</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;pct_ion&quot;</span> <span class="ow">in</span> <span class="n">hp</span><span class="p">:</span>
            <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ne</span><span class="o">/</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;pct_ion&quot;</span><span class="p">]))</span>
            <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;pct_ion&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Ne</span><span class="o">/</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;pct_ion&quot;</span><span class="p">]))</span>

        <span class="c1"># Compute E with NP and L</span>
        <span class="n">n_gas</span> <span class="o">=</span> <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">][</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;gas_index&quot;</span><span class="p">]]</span><span class="o">/</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>
        <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EoN</span><span class="o">*</span><span class="n">n_gas</span>
        <span class="c1"># Compute DT with E, EP_0, DE</span>
        <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;DT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">QE</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;DE&quot;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">QE</span><span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ME</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">QE</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;EP_0&quot;</span><span class="p">]))</span>

        <span class="c1"># Scale individual parameters beyond calibrated values.</span>
        <span class="c1"># Note, this will break E/N initial condition</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;pc_scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;NP&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">k</span><span class="p">])):</span>
                    <span class="n">tb</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tb</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">*</span><span class="n">tb</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_constrain_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use alternative parameters to derive those required</span>
<span class="sd">        for the ThunderBoltz input files.&quot;&quot;&quot;</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span>
        <span class="n">hp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span>
        <span class="c1"># Check gas index</span>
        <span class="k">if</span> <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;gas_index&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Assume there must be a gas for reduced calculations</span>
            <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;gas_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;autostep&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;DE&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Specify max DeltaE per time step for autostep&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;Ered&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Specify reduced field (E/N) for autostep&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;pct_ion&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Specify percent ionization (pct_ion) for autostep&quot;</span><span class="p">)</span>
            <span class="c1"># Calculate Nprod constraint and time step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_impose_nprod_crit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;pct_ion&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;NN&quot;</span><span class="p">]:</span>
            <span class="c1"># Calculate # of particles</span>
            <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;NN&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;pct_ion&quot;</span><span class="p">]),</span> <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;NN&quot;</span><span class="p">]]</span>

        <span class="c1"># Gas density</span>
        <span class="n">n_gas</span> <span class="o">=</span> <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">][</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;gas_index&quot;</span><span class="p">]]</span><span class="o">/</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>

        <span class="c1"># Calculate other derived parameters, if need be</span>
        <span class="k">if</span> <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]:</span>
            <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;NS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">//</span> <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;DT&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;Ered&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Calculate E-field in V/m such that particle 0</span>
            <span class="c1"># is accelerated in the +z direction</span>
            <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;QP&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">*</span><span class="mf">1e-21</span><span class="o">*</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;Ered&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">n_gas</span>

        <span class="k">if</span> <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;Bred&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;Bred&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please specify all three components of the &quot;</span>
                                   <span class="s2">&quot;reduced magnetic field.&quot;</span><span class="p">)</span>
            <span class="c1"># Calculate absolute B-field in Gauss (1 Gauss = 1e23 Hx m^-3)</span>
            <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e-27</span><span class="o">*</span><span class="n">Bred_i</span><span class="o">*</span><span class="n">n_gas</span> <span class="k">for</span> <span class="n">Bred_i</span> <span class="ow">in</span> <span class="n">hp</span><span class="p">[</span><span class="s2">&quot;Bred&quot;</span><span class="p">]]</span>

        <span class="c1"># Round NP if its not already an integer</span>
        <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">_validate_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make sure the ThunderBoltz indeck will be valid before running.&quot;&quot;&quot;</span>
        <span class="c1"># Alias</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span>
        <span class="c1"># Make sure QP and MP are correctly specified</span>
        <span class="n">SP</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;QP&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SP</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;MP&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;QP and MP arguments do not match in length&quot;</span><span class="p">)</span>
        <span class="k">pass</span>
        <span class="c1"># All other multi-argument settings should not exceed these in length match SP parameter</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">SP</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">,</span> <span class="s2">&quot;TP&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Some multi-argument parameters do not match in length&quot;</span><span class="p">)</span>

        <span class="c1"># Infer number of species from number of charge and mass arguments</span>
        <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;SP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SP</span>

        <span class="c1"># If multi-argument settings are shorter in length than inferred SP, set to 0</span>
        <span class="n">arg_diff</span> <span class="o">=</span> <span class="n">SP</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">arg_diff</span><span class="p">:</span>
            <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">arg_diff</span><span class="p">)</span>
        <span class="n">arg_diff</span> <span class="o">=</span> <span class="n">SP</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;TP&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">arg_diff</span><span class="p">:</span>
            <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;TP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="n">arg_diff</span><span class="p">)</span>
        <span class="n">arg_diff</span> <span class="o">=</span> <span class="n">SP</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="s2">&quot;VV&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">arg_diff</span><span class="p">:</span>
            <span class="n">tb</span><span class="p">[</span><span class="s2">&quot;VV&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="n">arg_diff</span><span class="p">)</span>

        <span class="c1"># Ensure that the indices in the CS indeck portion do not exceed SP</span>
        <span class="n">cs_sp_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">table</span><span class="p">[[</span><span class="s2">&quot;r1&quot;</span><span class="p">,</span> <span class="s2">&quot;r2&quot;</span><span class="p">,</span> <span class="s2">&quot;p1&quot;</span><span class="p">,</span> <span class="s2">&quot;p2&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">cs_sp_count</span> <span class="o">&gt;</span> <span class="n">SP</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Collision model species indices exceeds &quot;</span>
                             <span class="s2">&quot;specified number of species: &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">cs_sp_count</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">SP</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ThunderBoltz.set_fixed_tracking"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.set_fixed_tracking.html#pytb.ThunderBoltz.set_fixed_tracking">[docs]</a>    <span class="k">def</span> <span class="nf">set_fixed_tracking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change all reaction species indices of differing reactant values</span>
<span class="sd">        to be between only particle 0 and 1 (e.g. 0+1-&gt;0+2 is changed to 0+1-&gt;0+1).&quot;&quot;&quot;</span>
        <span class="n">diff_msk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">r1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">r2</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff_msk</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diff_msk</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;r1&quot;</span><span class="p">,</span> <span class="s2">&quot;r2&quot;</span><span class="p">,</span> <span class="s2">&quot;p1&quot;</span><span class="p">,</span> <span class="s2">&quot;p2&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="ThunderBoltz.write_input"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.write_input.html#pytb.ThunderBoltz.write_input">[docs]</a>    <span class="k">def</span> <span class="nf">write_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write all the input files into a directory with</span>
<span class="sd">        the current settings.</span>

<span class="sd">        Args:</span>
<span class="sd">            directory (str): The path to the simulation directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Write cross section files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">directory</span><span class="p">)</span>
        <span class="c1"># Write particle velocity init files if necessary.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdf_init_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">vdf_dat</span><span class="p">,</span> <span class="n">ptype</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vdf_init_data</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="p">[</span><span class="s2">&quot;LV&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">vdf_dat</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Write simulation params into input.in</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pjoin</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;input.in&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tb_parameters</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span>  <span class="n">v</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Write CS arguments</span>
            <span class="n">cs_deck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">get_deck</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cs_deck</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">written_input</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ThunderBoltz.compile_from"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.compile_from.html#pytb.ThunderBoltz.compile_from">[docs]</a>    <span class="k">def</span> <span class="nf">compile_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_path</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy TB files from src_path and compile</span>
<span class="sd">        in simulation directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            src_path (str): The location of the source files</span>
<span class="sd">                to compile from.</span>
<span class="sd">            debug (bool): If ``True``, compile C++ with the ``-g``</span>
<span class="sd">                debug flag.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: if there is a compilation issue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get source file names</span>
        <span class="n">src_files</span> <span class="o">=</span> <span class="n">ls</span><span class="p">(</span><span class="n">src_path</span><span class="p">)</span>
        <span class="c1"># Copy each to simulation directory</span>
        <span class="k">for</span> <span class="n">sf</span> <span class="ow">in</span> <span class="n">src_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;.cpp&quot;</span> <span class="ow">in</span> <span class="n">sf</span> <span class="ow">or</span> <span class="s2">&quot;.h&quot;</span> <span class="ow">in</span> <span class="n">sf</span><span class="p">:</span>
                <span class="n">src_file_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">sf</span><span class="p">)</span>
                <span class="n">dest_file_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">sf</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src_file_path</span><span class="p">,</span> <span class="n">dest_file_path</span><span class="p">)</span>

        <span class="c1"># Go to simulation directory and compile</span>
        <span class="n">pwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>

        <span class="c1"># Compile (hard-coded for security reasons).</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;g++ -std=c++17 DSMC0D.cpp -o thunderboltz.bin -Wall -Werror -Wsign-compare&quot;</span>
        <span class="c1"># Debug</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;g++ -g -std=c++17 DSMC0D.cpp -o thunderboltz.debug -Wall -Werror -Wsign-compare&quot;</span>
        <span class="n">cerr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cerr</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to compile.&quot;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThunderBoltz.compile_debug"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.compile_debug.html#pytb.ThunderBoltz.compile_debug">[docs]</a>    <span class="k">def</span> <span class="nf">compile_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare all files and compile with -g debug flag.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dryrun</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThunderBoltz.add_callback"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.add_callback.html#pytb.ThunderBoltz.add_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a function to the list of functions that will be</span>
<span class="sd">        called during banner output.</span>

<span class="sd">        Args:</span>
<span class="sd">            f (callable[,]): The function that will be called. It</span>
<span class="sd">                should accept no arguments and return no arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThunderBoltz.run"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.run.html#pytb.ThunderBoltz.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bin_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="s2">&quot;thunderboltz&quot;</span><span class="p">,</span>
            <span class="n">monitor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">std_banner</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">live</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">live_rate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute with the current parameters in the simulation directory.</span>
<span class="sd">           The internal API ThunderBoltz version will be used in lieu of</span>
<span class="sd">           user-provided binary/source files.</span>

<span class="sd">        Args:</span>
<span class="sd">            src_path (str): Optional path to source files to copy into the</span>
<span class="sd">                simulation directory. The source is then compiled there.</span>
<span class="sd">            bin_path (str): Optional path to binary executable to copy</span>
<span class="sd">                into the simulation directory.</span>
<span class="sd">            out_file (str): The file name for stdout buffer of the</span>
<span class="sd">                ThunderBoltz process.</span>
<span class="sd">            monitor (bool): Runtime flag, when set to `True` will generate</span>
<span class="sd">                an empty `monitor` file in the simulation directory. Deleting this</span>
<span class="sd">                file will cause the ThunderBoltz process to exit, but allow</span>
<span class="sd">                the wrapper to continue execution. This is useful performing</span>
<span class="sd">                several simulation calculations sequentially, but a manual exit</span>
<span class="sd">                is required for each one.</span>
<span class="sd">            dryrun (bool): Setup all the files for the calculation, but do not</span>
<span class="sd">                run the calculation.</span>
<span class="sd">            debug: (bool): Compile with C++ ``-g`` debug flag.</span>
<span class="sd">            std_banner (bool): Toggle banner output streaming to stdout in</span>
<span class="sd">                addition to being written to the ``out_file`` buffer.</span>
<span class="sd">            live (bool): Run and update time series plotting GUI during simulation.</span>
<span class="sd">            live_rate (bool): Run and update rate plotting GUI during simulation.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: if there is no simulation directory set or if</span>
<span class="sd">                the one provided does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Simulation directory has not been established&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Simulation directory does not exist&quot;</span><span class="p">)</span>

        <span class="c1"># Overwrite monitor, out_file, and live options</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="n">out_file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">live</span> <span class="o">=</span> <span class="n">live</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_rate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">live_rate</span> <span class="o">=</span> <span class="n">live_rate</span>

        <span class="c1"># Validate parameters and write indeck files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_input</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">written_input</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>

        <span class="c1"># Determine binary TB file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bin_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">src_path</span><span class="p">:</span>
                <span class="c1"># Use internal package src</span>
                <span class="n">src_path</span> <span class="o">=</span> <span class="n">pytb</span><span class="o">.</span><span class="n">src_path</span>
            <span class="c1"># Create binary file from source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compile_from</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Copy binary file from user path</span>
            <span class="n">bin_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">bin_path</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bin_path</span><span class="p">,</span> <span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">bin_file</span><span class="p">))</span>

        <span class="c1"># Record time and log params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m-%y_%H:%M:%S&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">()</span>

        <span class="c1"># Do not run ThunderBoltz for dry runs</span>
        <span class="k">if</span> <span class="n">dryrun</span><span class="p">:</span> <span class="k">return</span>

        <span class="c1">##### Run the program #####</span>

        <span class="c1"># Sub-process commands hard-coded for security reasons</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;./thunderboltz.bin&quot;</span><span class="p">,</span> <span class="s2">&quot;input.in&quot;</span><span class="p">]</span>

        <span class="c1"># Create callbacks for communication between the</span>
        <span class="c1"># ThunderBoltz thread and this parent thread.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">:</span>
            <span class="c1"># Create temporary monitor file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;monitor&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># Write empty file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_callback</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>
            <span class="c1"># Live time series plotting</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_live_ts_callback</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_rate</span><span class="p">:</span>
            <span class="c1"># Live rate coefficient plotting</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_live_rate_callback</span><span class="p">)</span>

        <span class="c1"># Start precision timer</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="c1"># Start the ThunderBoltz subprocess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interactive_subprocess</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="n">std_banner</span><span class="p">,</span>
            <span class="n">std_buf</span><span class="o">=</span><span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="o">+</span><span class="s2">&quot;.out&quot;</span><span class="p">),</span>
            <span class="n">err_buf</span><span class="o">=</span><span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="o">+</span><span class="s2">&quot;.err&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># After subprocess exits, record wall-clock time.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m-%y_%H:%M:%S&quot;</span><span class="p">)</span>

        <span class="c1"># Update log files with elapsed times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_interactive_subprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">std_buf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">err_buf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open a subprocess for the ThunderBoltz simulation and</span>
<span class="sd">        pipe the output back to the parent. Optionally allow for</span>
<span class="sd">        &#39;tee&#39;-like behavior and also print out process</span>
<span class="sd">        stdout at the same time.&quot;&quot;&quot;</span>
        <span class="c1"># Start process in simulation directory</span>
        <span class="k">with</span> <span class="n">visit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="c1"># Alias</span>
        <span class="c1"># Ensure file reading doesn&#39;t wait for subprocess to close when</span>
        <span class="c1"># sending updates</span>
        <span class="n">os</span><span class="o">.</span><span class="n">set_blocking</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">std_buf</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">std_buf</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">run_callbacks</span><span class="p">():</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">std_buf</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span> <span class="p">[</span><span class="n">c</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tee</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">p</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Release lock to the subprocess if running</span>
            <span class="c1"># on one core.</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">run_callbacks</span><span class="p">()</span>

        <span class="c1"># Run buffering one last time.</span>
        <span class="n">run_callbacks</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">std_buf</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Log errors into .err file after failure and raise</span>
        <span class="c1"># as warning in the parent</span>
        <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">err_buf</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">err_buf</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">_monitor_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exit the ThunderBoltz process when the</span>
<span class="sd">        monitor file is removed by the user.&quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="c1"># Alias</span>

        <span class="c1"># Check if monitor file is still there, or if process ended.</span>
        <span class="n">monfile</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;monitor&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">monfile</span><span class="p">)</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># At this point, the process is either terminated, or should be</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="c1"># And the monitor file is either deleted, or should be</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">monfile</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">monfile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_live_ts_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the time series GUI.&quot;&quot;&quot;</span>
        <span class="c1"># Make sure output files have data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
                <span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="o">+</span><span class="s2">&quot;.out&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="c1"># Don&#39;t try to plot anything</span>

        <span class="c1"># Clear plots for data redraw if not initialized yet</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_fig</span><span class="p">:</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_fig</span><span class="o">.</span><span class="n">axes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_timeseries</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_fig</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_live_rate_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the rate plot GUI.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
                <span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="o">+</span><span class="s2">&quot;.out&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="c1"># Don&#39;t try to plot anything</span>

        <span class="c1"># Clear plots for data redraw if not initialized yet</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_fig</span><span class="p">:</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_fig</span><span class="o">.</span><span class="n">axes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_rates</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_fig</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>

<div class="viewcode-block" id="ThunderBoltz.read_stdout"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.read_stdout.html#pytb.ThunderBoltz.read_stdout">[docs]</a>    <span class="k">def</span> <span class="nf">read_stdout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the banner output data.</span>

<span class="sd">        Args:</span>
<span class="sd">            fname (str): The name of the ``.out`` file to read.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`pandas.DataFrame`: The banner data.</span>

<span class="sd">        Note:</span>
<span class="sd">            If ThunderBoltz warnings are found (e.g. particle overload),</span>
<span class="sd">            a message will be appended to ``err_stack``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># Get to data lines</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">while</span> <span class="s2">&quot;0, t&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;Too many particles!&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">err_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;particle overload&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">kinetic_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                    <span class="k">return</span>

                <span class="n">l</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="c1"># Read the rest of the lines</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kinetic_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c1"># Convert line data to DataFrame</span>
        <span class="k">if</span> <span class="s2">&quot;Too many particles!&quot;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;particle overload&quot;</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="c1"># Ignore comments</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)]</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">cmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">txt</span><span class="p">),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
            <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">autostrip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmax</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kinetic_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetic_table</span></div>

<div class="viewcode-block" id="ThunderBoltz.read_particle_table"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.read_particle_table.html#pytb.ThunderBoltz.read_particle_table">[docs]</a>    <span class="k">def</span> <span class="nf">read_particle_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read species specific output data, including</span>
<span class="sd">        density, velocity, displacement, energy, and temperature.</span>

<span class="sd">        Args:</span>
<span class="sd">            i (int): The species index.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`pandas.DataFrame`: The particle data for</span>
<span class="sd">            species ``i``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fpath</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Particle_Type_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">column_names</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">txt</span><span class="p">),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
                <span class="n">autostrip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ndmin</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_tables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_tables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="ThunderBoltz.read"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.read.html#pytb.ThunderBoltz.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">read_input</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">read_cs_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the simulation directory of a ThunderBoltz run, possibly</span>
<span class="sd">        all of its input and output files.</span>

<span class="sd">        Args:</span>
<span class="sd">            directory (str): The location of the simulation directory</span>
<span class="sd">                from which to read.</span>
<span class="sd">            read_input (bool): Whether or not to read any input data.</span>
<span class="sd">            read_cs_data (bool): Whether or not to read cross section data.</span>
<span class="sd">                This can be expensive, and often isn&#39;t necessary.</span>
<span class="sd">            only (list or None): Only read certain types of files. Default is</span>
<span class="sd">                ``[&quot;thunderboltz.out&quot;, &quot;Particle_Type&quot;, &quot;Counts.dat&quot;, &quot;&quot;thunderboltz.log&quot;]``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">directory</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span>

        <span class="k">if</span> <span class="n">read_input</span><span class="p">:</span>
            <span class="c1"># Read cross sections input first</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">read_cs_data</span><span class="o">=</span><span class="n">read_cs_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_tb_params</span><span class="p">(</span><span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">input_fname</span><span class="p">))</span>
        <span class="c1"># Read other files</span>
        <span class="n">logfiles</span> <span class="o">=</span> <span class="n">ls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">only</span><span class="p">:</span>
            <span class="n">logfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">only</span> <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">logfiles</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">logfiles</span><span class="p">:</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;Counts.dat&quot;</span><span class="p">:</span>
                <span class="n">counts_dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">counts_dat</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">counts_dat</span> <span class="o">=</span> <span class="n">counts_dat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">counts_dat</span><span class="p">,</span>
                    <span class="n">columns</span> <span class="o">=</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">csfile</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;thunderboltz.out&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_stdout</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">filename</span> <span class="o">==</span> <span class="s2">&quot;thunderboltz.log&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_log</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># Read particle type files in order</span>
        <span class="k">if</span> <span class="n">only</span> <span class="ow">and</span> <span class="s2">&quot;Particle_Type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">only</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">pfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;Particle_Type&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_tables</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">pfiles</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pfiles</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_particle_table</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThunderBoltz.get_particle_tables"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.get_particle_tables.html#pytb.ThunderBoltz.get_particle_tables">[docs]</a>    <span class="k">def</span> <span class="nf">get_particle_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the particle table data for each species</span>
<span class="sd">        in a list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[ :class:`pandas.DataFrame`]: The list of particle</span>
<span class="sd">            table data. Each table with have columns with keywords</span>
<span class="sd">            matching the attributes of</span>
<span class="sd">            :class:`~.pytb.parameters.ParticleParameters`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Implicitly call the main output parsing code.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_timeseries</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_tables</span></div>

<div class="viewcode-block" id="ThunderBoltz.get_timeseries"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.get_timeseries.html#pytb.ThunderBoltz.get_timeseries">[docs]</a>    <span class="k">def</span> <span class="nf">get_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect the relevant time series data from a ThunderBoltz simulation</span>
<span class="sd">        directory and add input parameter columns.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`pandas.DataFrame`: The table of time series data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Read output files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">only</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_files</span><span class="p">,</span> <span class="n">read_input</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Make sure actual output files got read</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_tables</span>
        <span class="n">kt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kinetic_table</span>

        <span class="k">if</span> <span class="n">kt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Missing output logs, make sure stdout and &quot;</span>
                               <span class="s2">&quot;particle tables are being written.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pt</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">kt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># Do not try to join until more data is available</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span>


        <span class="c1"># Create time series</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span> <span class="o">=</span> <span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kt</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span>

        <span class="c1"># Add input and meta parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tabulate</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

        <span class="c1"># Compute some additional parameters</span>
        <span class="n">DT</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Calculate gas density</span>
        <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;n_gas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="p">[</span><span class="s2">&quot;NP&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;gas_index&quot;</span><span class="p">]]</span><span class="o">/</span><span class="n">ts</span><span class="o">.</span><span class="n">L</span><span class="o">**</span><span class="mi">3</span>
        <span class="c1"># Calculate Reduced field</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;mobN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">Vzi</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">/</span><span class="n">ts</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">*</span><span class="n">ts</span><span class="o">.</span><span class="n">n_gas</span>
        <span class="c1"># Reduced Townshend ionization coefficient</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_rates</span><span class="p">()</span>

        <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;a_n&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">k_i</span> <span class="o">/</span> <span class="n">ts</span><span class="o">.</span><span class="n">Vzi</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="c1"># Calculate bulk parameters if position data is available</span>
        <span class="k">if</span> <span class="s2">&quot;Rzi&quot;</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">:</span>
            <span class="n">zdrift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">Rzi</span><span class="p">)</span><span class="o">/</span><span class="n">DT</span><span class="p">)))</span>
            <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;bulk_drift&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zdrift</span>
            <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;Rzi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">Rzi</span>
            <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;mobN_bulk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zdrift</span><span class="o">/</span><span class="n">ts</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">*</span><span class="n">ts</span><span class="o">.</span><span class="n">n_gas</span>
            <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;a_n_bulk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">k_i</span> <span class="o">/</span> <span class="n">zdrift</span>
        <span class="k">return</span> <span class="n">ts</span></div>

    <span class="k">def</span> <span class="nf">_calculate_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate rate coefficients from reaction counts.&quot;&quot;&quot;</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_tables</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">)</span>

        <span class="c1"># Find the shortest list (if files are still being written by process)</span>
        <span class="n">npoints</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="o">*</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pt</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="c1"># Truncate counts to the shortest</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">npoints</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">DT</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Compute collision rate data</span>
        <span class="n">dcdt</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-</span><span class="n">c</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">/</span><span class="n">DT</span>
        <span class="n">ctab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">table</span>
        <span class="c1"># Get ionization collision files.</span>
        <span class="n">ionz_files</span> <span class="o">=</span> <span class="n">ctab</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">ctab</span><span class="o">.</span><span class="n">rtype</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;Ionization&quot;</span><span class="p">))</span>
                             <span class="o">|</span><span class="p">(</span><span class="n">ctab</span><span class="o">.</span><span class="n">csfile</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;ion&quot;</span><span class="p">)),</span> <span class="s2">&quot;csfile&quot;</span><span class="p">]</span>
        <span class="n">ionz_c</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">ionz_files</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Compute total ionization count</span>
        <span class="n">tot_ionz_c</span> <span class="o">=</span> <span class="n">ionz_c</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># Compute total interaction count over all processes</span>
        <span class="n">total_c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># For now use the most accurate time step values and assume constant DT</span>
        <span class="n">ionz_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tot_ionz_c</span><span class="p">)</span><span class="o">/</span><span class="n">DT</span><span class="p">))</span>
        <span class="n">tot_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">total_c</span><span class="p">)</span><span class="o">/</span><span class="n">DT</span><span class="p">))</span>

        <span class="c1"># Generate specific rates for ionization and total processes</span>
        <span class="n">k_scale</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">n_gas</span><span class="o">*</span><span class="n">ts</span><span class="o">.</span><span class="n">Ni</span><span class="o">*</span><span class="n">ts</span><span class="o">.</span><span class="n">L</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;k_i&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ionz_rate</span><span class="o">*</span><span class="n">k_scale</span>
        <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;k_tot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot_rate</span><span class="o">*</span><span class="n">k_scale</span>

        <span class="c1"># Generate rates for all processes individually</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">ctab</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">k_scaler</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">r1</span><span class="p">]</span><span class="o">.</span><span class="n">Ni</span> <span class="o">*</span> <span class="n">pt</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">r2</span><span class="p">]</span><span class="o">.</span><span class="n">Ni</span> <span class="o">*</span> <span class="n">ts</span><span class="o">.</span><span class="n">L</span><span class="o">**</span><span class="mi">3</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">npoints</span><span class="p">]</span>
            <span class="n">k_scaler</span><span class="p">[</span><span class="n">k_scaler</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">k_vals</span> <span class="o">=</span> <span class="p">(</span><span class="n">dcdt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">npoints</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">k_scaler</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">k_vals</span><span class="p">),</span><span class="sa">f</span><span class="s2">&quot;k_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_vals</span>

<div class="viewcode-block" id="ThunderBoltz.get_ss_params"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.get_ss_params.html#pytb.ThunderBoltz.get_ss_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_ss_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ss_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get steady-state transport parameter values by averaging last section</span>
<span class="sd">        of time series. By default, the last fourth of the available data is</span>
<span class="sd">        considered to be steady-state. Standard deviations over this interval</span>
<span class="sd">        will be computed for each parameter in a new column with a &quot;_std&quot;</span>
<span class="sd">        suffix added to the column name.</span>

<span class="sd">        Args:</span>
<span class="sd">            ss_func (callable[:class:`pandas.DataFrame`, :class:`pandas.DataFrame`]):</span>
<span class="sd">                A function that takes in the numerical time series data and returns a</span>
<span class="sd">                truncated set of time series data that is considered to be at</span>
<span class="sd">                steady state.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`pandas.DataFrame`: The aggregated steady-state data for</span>
<span class="sd">            each output parameter along with columns specifying the input</span>
<span class="sd">            parameters.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeWarning: if not enough steps are available to compute steady</span>
<span class="sd">                state statistics.</span>

<span class="sd">        Warning:</span>
<span class="sd">            Currently, the last quarter of the time series data is assumed to be</span>
<span class="sd">            in steady-state by default when calculating these steady-state parameters.</span>
<span class="sd">            One can verify that this is true by viewing the figures produced by</span>
<span class="sd">            :py:func:`plot_timeseries`. Otherwise, one may run the simulation for longer,</span>
<span class="sd">            or provide the appropriate criteria via ``ss_func``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeseries</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
                <span class="c1"># Return empty data</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span>
        <span class="c1"># Get numerical time series data</span>
        <span class="n">tsn</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">containment</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1"># (False)</span>
        <span class="n">endP</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">std_bar</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="n">ss_func</span><span class="p">:</span>
            <span class="n">ts_last</span> <span class="o">=</span> <span class="n">ss_func</span><span class="p">(</span><span class="n">tsn</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tsn</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="c1"># take last fourth</span>
            <span class="n">ts_last</span> <span class="o">=</span> <span class="n">tsn</span><span class="p">[</span><span class="n">tsn</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">tsn</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ts_last</span> <span class="o">=</span> <span class="n">tsn</span><span class="p">[</span><span class="n">tsn</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">tsn</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">end_ts</span> <span class="o">=</span> <span class="n">ts_last</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">endP</span><span class="p">:,:]</span>
            <span class="n">es</span> <span class="o">=</span> <span class="n">end_ts</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">])</span>
            <span class="n">mEm</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;MEe&quot;</span><span class="p">]</span>
            <span class="n">mEs</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;MEe&quot;</span><span class="p">]</span>
            <span class="c1"># Calculate a rough indicator of convergence (fractional %)</span>
            <span class="n">contained</span> <span class="o">=</span> <span class="n">ts_last</span><span class="p">[(</span><span class="n">ts_last</span><span class="o">.</span><span class="n">MEe</span> <span class="o">&gt;</span> <span class="n">mEm</span><span class="o">-</span><span class="n">std_bar</span><span class="o">*</span><span class="n">mEs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ts_last</span><span class="o">.</span><span class="n">MEe</span> <span class="o">&lt;</span> <span class="n">mEm</span><span class="o">+</span><span class="n">std_bar</span><span class="o">*</span><span class="n">mEs</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">containment</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contained</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ts_last</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts_last</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Not enough steps to generate steady-state statistics&quot;</span><span class="p">)</span>
        <span class="c1"># Set time step after which stats are generated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_conv</span> <span class="o">=</span> <span class="n">ts_last</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Calculate time derivative based parameters</span>
        <span class="n">LR</span> <span class="o">=</span> <span class="n">linregress</span><span class="p">(</span><span class="n">ts_last</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">ts_last</span><span class="o">.</span><span class="n">Rzi</span><span class="p">)</span>
        <span class="n">zdrift</span> <span class="o">=</span> <span class="n">LR</span><span class="o">.</span><span class="n">slope</span>
        <span class="n">anbf</span> <span class="o">=</span> <span class="s2">&quot;a_n_bulk_fit&quot;</span>
        <span class="n">mnbf</span> <span class="o">=</span> <span class="s2">&quot;mobN_bulk_fit&quot;</span>
        <span class="n">ts_last</span><span class="p">[</span><span class="n">anbf</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_last</span><span class="o">.</span><span class="n">k_i</span> <span class="o">/</span> <span class="n">zdrift</span>
        <span class="n">ts_last</span><span class="p">[</span><span class="n">mnbf</span><span class="p">]</span> <span class="o">=</span> <span class="n">zdrift</span><span class="o">/</span><span class="n">ts_last</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">*</span><span class="n">ts_last</span><span class="o">.</span><span class="n">n_gas</span>
        <span class="c1"># Update time series with these parameters</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ts</span><span class="o">.</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_conv</span><span class="p">,</span> <span class="p">[</span><span class="n">anbf</span><span class="p">,</span> <span class="n">mnbf</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ts_last</span><span class="p">[[</span><span class="n">anbf</span><span class="p">,</span> <span class="n">mnbf</span><span class="p">]]</span>

        <span class="c1"># Calculate steady-state statistics by aggregating over time</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">ts_last</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">.9</span><span class="p">)])</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="p">:],</span>
                           <span class="n">stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s2">&quot;_std&quot;</span><span class="p">),</span>
        <span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Correct uncertainty in fit with stderr</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">mnbf</span><span class="o">+</span><span class="s2">&quot;_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">mnbf</span><span class="p">]</span><span class="o">*</span><span class="n">LR</span><span class="o">.</span><span class="n">stderr</span><span class="o">/</span><span class="n">zdrift</span>
        <span class="n">stats</span><span class="p">[</span><span class="n">anbf</span><span class="o">+</span><span class="s2">&quot;_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">anbf</span><span class="p">]</span><span class="o">*</span><span class="n">LR</span><span class="o">.</span><span class="n">stderr</span><span class="o">/</span><span class="n">zdrift</span>

        <span class="c1"># Save convergence criteria</span>
        <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;containment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">containment</span>

        <span class="c1"># Add input / meta parameters</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">stats</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tabulate</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stats</span></div>

<div class="viewcode-block" id="ThunderBoltz.get_etrans"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.get_etrans.html#pytb.ThunderBoltz.get_etrans">[docs]</a>    <span class="k">def</span> <span class="nf">get_etrans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the energy weighted counts of each reaction computed</span>
<span class="sd">        for each time step.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`pandas.DataFrame`: A table of each process and the</span>
<span class="sd">            energy transfer through that channel as a proportion</span>
<span class="sd">            to the total energy transfer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;csfile&quot;</span><span class="p">)</span>
        <span class="n">weighted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Loop through columns of reaction count table.</span>
        <span class="k">for</span> <span class="n">reaction</span> <span class="ow">in</span> <span class="n">weighted</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">weighted</span><span class="p">[</span><span class="n">reaction</span><span class="p">]</span> <span class="o">*=</span> <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reaction</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">]</span>
        <span class="n">weighted</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">weighted</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">weighted</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weighted</span></div>

<div class="viewcode-block" id="ThunderBoltz.get_vdfs"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.get_vdfs.html#pytb.ThunderBoltz.get_vdfs">[docs]</a>    <span class="k">def</span> <span class="nf">get_vdfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">sample_cap</span><span class="o">=</span><span class="mi">500000</span><span class="p">,</span> <span class="n">particle_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the electron velocities arrays within a ThunderBoltz calculation.</span>
<span class="sd">        Velocity units are in m/s. If velocity dump files are found</span>
<span class="sd">        corresponding to ``steps``, update ``vdfs``.</span>

<span class="sd">        Args:</span>
<span class="sd">            steps (str, list[int], or int): Options for which time steps to</span>
<span class="sd">                read:</span>

<span class="sd">                * ``&quot;last&quot;``: Only read the VDF of the last time step</span>
<span class="sd">                * ``&quot;first&quot;``: Only read the VDF of the first time step</span>
<span class="sd">                * ``&quot;all&quot;``: Read a separate VDF for each time step.</span>
<span class="sd">                * ``list[int]``: Read VDF for each time step included in list.</span>
<span class="sd">                * ``int``: read VDF at one specific time step.</span>

<span class="sd">            sample_cap (int): Limit the number of samples read from the dump</span>
<span class="sd">                file for very large files. Default is 500000. If bool(sample_cap)</span>
<span class="sd">                evaluates to ``False``, then no cap will be imposed.</span>
<span class="sd">            particle_type (str, list[int], or int): Specify which kinds of species data</span>
<span class="sd">                should be read from.</span>

<span class="sd">                * ``int``: The particle type to read. Default is ``0``.</span>
<span class="sd">                * ``list[int]``: A set of particle types to read.</span>
<span class="sd">                * ``&quot;all&quot;``: Read all particle types.</span>

<span class="sd">            v (int): Verbosity -- 0: silent, 1: print file paths before reading.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`pandas.DataFrame`: The particle velocity dump data.</span>

<span class="sd">        Warning:</span>
<span class="sd">            Large files are truncated to the first ``sample_cap`` lines.</span>
<span class="sd">            It is assumed that the particle ordering in the dump files</span>
<span class="sd">            is not correlated with any velocity statistics, but</span>
<span class="sd">            this may not be the case when ``egen`` is on. In that case, ensure</span>
<span class="sd">            the entire velocity dump file is being read.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check what&#39;s available out of the requested</span>
        <span class="n">available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_available_vdfs</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">available</span><span class="p">):</span>
            <span class="k">return</span> <span class="c1"># Nothing to plot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Initialize empty DataFrame with named columns</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;ptype&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">],</span>
                                    <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)})</span>
                <span class="c1"># Keep &quot;vx ... vz&quot; as the last three columns</span>

        <span class="c1"># Find which steps are missing from current vdf table</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="o">.</span><span class="n">ptype</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">available</span>
                   <span class="k">if</span> <span class="n">step</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">]</span>
        <span class="c1"># Extract them from the simulation directory.</span>
        <span class="n">missing_vdfs</span> <span class="o">=</span> <span class="n">parsing</span><span class="o">.</span><span class="n">extract_vdfs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">missing</span><span class="p">,</span> <span class="n">sample_cap</span><span class="o">=</span><span class="n">sample_cap</span><span class="p">,</span>
            <span class="n">particle_type</span><span class="o">=</span><span class="n">particle_type</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Only read the missing ones</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="p">,</span> <span class="n">missing_vdfs</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span></div>

<div class="viewcode-block" id="ThunderBoltz.get_edfs"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.get_edfs.html#pytb.ThunderBoltz.get_edfs">[docs]</a>    <span class="k">def</span> <span class="nf">get_edfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">sample_cap</span><span class="o">=</span><span class="mi">500000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the electron velocity distribution functions and return</span>
<span class="sd">        the component and total energy distributions within a</span>
<span class="sd">        ThunderBoltz calculation. Energy units are in eV. Invokes</span>
<span class="sd">        :func:`get_vdfs`.</span>

<span class="sd">        Args:</span>
<span class="sd">            steps (str, list[int], or int): Options for which time steps to</span>
<span class="sd">                read:</span>

<span class="sd">                * ``&quot;last&quot;``: Only read the VDF of the last time step</span>
<span class="sd">                * ``&quot;first&quot;``: Only read the VDF of the first time step</span>
<span class="sd">                * ``&quot;all&quot;``: Read a separate VDF for each time step.</span>
<span class="sd">                * ``list[int]``: Read VDF for each time step included in list.</span>
<span class="sd">                * ``int``: read VDF at one specific time step.</span>

<span class="sd">            sample_cap (int): Limit the number of samples read from the dump</span>
<span class="sd">                file for very large files. Default is 500000. If bool(sample_cap)</span>
<span class="sd">                evaluates to ``False``, then no cap will be imposed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`pandas.DataFrame`: A table with the signed and unsigned</span>
<span class="sd">                energy components of each particle.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_vdfs</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">sample_cap</span><span class="p">)</span>
        <span class="n">edf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]})</span>
        <span class="c1"># Transform columns to eV, first signed energies</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="p">[</span><span class="s2">&quot;MP&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">AMU_TO_KG</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Ex&quot;</span><span class="p">,</span> <span class="s2">&quot;Ey&quot;</span><span class="p">,</span> <span class="s2">&quot;Ez&quot;</span><span class="p">]:</span>
            <span class="n">edf</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s2">&quot;_signed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">m</span><span class="o">/</span><span class="n">QE</span> <span class="o">*</span> <span class="n">edf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="n">edf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">)</span>
        <span class="c1"># Then the unsigned</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Ex&quot;</span><span class="p">,</span> <span class="s2">&quot;Ey&quot;</span><span class="p">,</span> <span class="s2">&quot;Ez&quot;</span><span class="p">]:</span>
            <span class="n">edf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">edf</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s2">&quot;_signed&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="c1"># Total energy is the sum of its orthogonal components.</span>
        <span class="n">edf</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edf</span><span class="o">.</span><span class="n">Ex</span> <span class="o">+</span> <span class="n">edf</span><span class="o">.</span><span class="n">Ey</span> <span class="o">+</span> <span class="n">edf</span><span class="o">.</span><span class="n">Ez</span>
        <span class="k">return</span> <span class="n">edf</span></div>

<div class="viewcode-block" id="ThunderBoltz.describe_dist"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.describe_dist.html#pytb.ThunderBoltz.describe_dist">[docs]</a>    <span class="k">def</span> <span class="nf">describe_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">sample_cap</span><span class="o">=</span><span class="mi">500000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate percentile and count statistics of the electron</span>
<span class="sd">        velocity / energy distribution for various time steps.</span>

<span class="sd">        Args:</span>
<span class="sd">            steps (str, list[int], or int): Options for which time steps to</span>
<span class="sd">                read:</span>

<span class="sd">                * ``&quot;last&quot;``: Only read the VDF of the last time step</span>
<span class="sd">                * ``&quot;first&quot;``: Only read the VDF of the first time step</span>
<span class="sd">                * ``&quot;all&quot;``: Read a separate VDF for each time step.</span>
<span class="sd">                * ``list[int]``: Read VDF for each time step included in list.</span>
<span class="sd">                * ``int``: read VDF at one specific time step.</span>

<span class="sd">            sample_cap (int): Limit the number of samples read from the dump</span>
<span class="sd">                file for very large files. Default is 500000. If bool(sample_cap)</span>
<span class="sd">                evaluates to ``False``, then no cap will be imposed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`pandas.DataFrame`: A table with statistical descriptions of</span>
<span class="sd">            the velocity and energy distributions.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get energy distribution, this will implicitly update self.vdfs</span>
        <span class="n">efs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_edfs</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">sample_cap</span><span class="p">)</span>
        <span class="c1"># Concatenate the two frames</span>
        <span class="n">joined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="p">,</span> <span class="n">efs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="o">-</span><span class="mi">4</span><span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">joined</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ptype&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">.1</span><span class="p">,</span> <span class="mf">.25</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="mf">.75</span><span class="p">,</span> <span class="mf">.9</span><span class="p">,</span> <span class="mf">.99</span><span class="p">])</span>
            <span class="o">.</span><span class="n">stack</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">stats</span></div>

<div class="viewcode-block" id="ThunderBoltz.set_ts_plot_params"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.set_ts_plot_params.html#pytb.ThunderBoltz.set_ts_plot_params">[docs]</a>    <span class="k">def</span> <span class="nf">set_ts_plot_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the default series plotted by</span>
<span class="sd">        :meth:`~pytb.ThunderBoltz.plot_timeseries`&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_plot_params</span> <span class="o">=</span> <span class="n">params</span></div>

<div class="viewcode-block" id="ThunderBoltz.plot_timeseries"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.plot_timeseries.html#pytb.ThunderBoltz.plot_timeseries">[docs]</a>    <span class="k">def</span> <span class="nf">plot_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stamp</span><span class="o">=</span><span class="p">[],</span> <span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a diagnostic plot of ThunderBoltz time series</span>
<span class="sd">        data.</span>

<span class="sd">        Args:</span>
<span class="sd">            series (list[str]):</span>
<span class="sd">                The y-parameters to plot onto the time series figure.</span>
<span class="sd">            save (str): Option to save the plot to a file path.</span>
<span class="sd">            stamp (list[str]): Option to stamp the figure with the value of</span>
<span class="sd">                descriptive parameters, e.g. the field, or initial</span>
<span class="sd">                number of particles. See :class:`~.pytb.parameters.TBParameters`</span>
<span class="sd">                and :class:`~.pytb.parameters.WrapParameters`.</span>
<span class="sd">            v (int): Verbosity -- 0: silent, 1: print file paths before</span>
<span class="sd">                plotting.</span>
<span class="sd">            update (bool): If set to ``False``, assume required data has</span>
<span class="sd">                already been parsed into ThunderBoltz frames.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`matplotlib.figure.Figure`: The timeseries figure object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">series</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_plot_params</span> <span class="o">=</span> <span class="n">series</span>
        <span class="c1"># If no data has been read yet, or program still running, read it</span>
        <span class="n">process_running</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">update</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">process_running</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_timeseries</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span><span class="p">):</span>
            <span class="k">return</span> <span class="c1"># No data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Timeseries data not read.&quot;</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Alias</span>

        <span class="c1"># Convert mobility values</span>
        <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;mobN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-24</span><span class="o">*</span><span class="n">ts</span><span class="o">.</span><span class="n">mobN</span>
        <span class="k">if</span> <span class="s2">&quot;mobN_bulk&quot;</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;mobN_bulk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-24</span><span class="o">*</span><span class="n">ts</span><span class="o">.</span><span class="n">mobN_bulk</span>
        <span class="k">if</span> <span class="s2">&quot;mobN_bulk_fit&quot;</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">:</span>
            <span class="n">ts</span><span class="p">[</span><span class="s2">&quot;mobN_bulk_fit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-24</span><span class="o">*</span><span class="n">ts</span><span class="o">.</span><span class="n">mobN_bulk_fit</span>

        <span class="c1"># Create figure and ax objects, if necessary</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_fig</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ts_fig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts_fig</span> <span class="c1"># Alias</span>

        <span class="c1"># Plot timeseries with this figure</span>
        <span class="n">plot_timeseries</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_plot_params</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">save</span><span class="p">)</span>
        <span class="c1"># super title</span>
        <span class="n">stamps</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">)</span>
        <span class="n">stamps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;directory&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stamps</span><span class="p">:</span>
            <span class="n">stamps</span><span class="p">[</span><span class="s2">&quot;directory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">stamps</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stamps</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">stamp</span><span class="p">}</span>
        <span class="c1"># Use pandas Series to create a pretty string.</span>
        <span class="n">stt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">stamps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">stt</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;family&quot;</span><span class="p">:</span> <span class="s2">&quot;monospace&quot;</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="c1"># Save with the name of the simulation directory</span>
            <span class="n">sname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">save</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save</span><span class="p">)</span>
            <span class="n">saveas</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">sname</span><span class="o">+</span><span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving time series in </span><span class="si">{</span><span class="n">saveas</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveas</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="ThunderBoltz.plot_rates"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.plot_rates.html#pytb.ThunderBoltz.plot_rates">[docs]</a>    <span class="k">def</span> <span class="nf">plot_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a diagnostic plot of ThunderBoltz time series</span>
<span class="sd">        data.</span>

<span class="sd">        Args:</span>
<span class="sd">            series (list[str]):</span>
<span class="sd">                The y-parameters to plot onto the time series figure.</span>
<span class="sd">            save (str): Option to save the plot to a file path.</span>
<span class="sd">            stamp (list[str]): Option to stamp the figure with the value of</span>
<span class="sd">                descriptive parameters, e.g. the field, or initial</span>
<span class="sd">                number of particles. See :class:`~.pytb.parameters.TBParameters`</span>
<span class="sd">                and :class:`~.pytb.parameters.WrapParameters`.</span>
<span class="sd">            v (int): Verbosity -- 0: silent, 1: print file paths before</span>
<span class="sd">                plotting.</span>
<span class="sd">            update (bool): If set to ``False``, assume required data has</span>
<span class="sd">                already been parsed into ThunderBoltz frames.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`matplotlib.figure.Figure`: The plot_rate figure object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rate_fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">update</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_timeseries</span><span class="p">()</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeseries</span>

        <span class="n">kkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;k_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;i&quot;</span>
                 <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;k_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;i&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span> <span class="k">continue</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">ts</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate Coefficient (m$^3$/s)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_fig</span></div>


<div class="viewcode-block" id="ThunderBoltz.plot_edf_comps"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.plot_edf_comps.html#pytb.ThunderBoltz.plot_edf_comps">[docs]</a>    <span class="k">def</span> <span class="nf">plot_edf_comps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">sample_cap</span><span class="o">=</span><span class="mi">500000</span><span class="p">,</span>
                       <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">maxwellian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the directional components of the energy distribution function.</span>

<span class="sd">        Args:</span>
<span class="sd">            steps (str, list[int], or int): Options for which time steps to</span>
<span class="sd">                read:</span>

<span class="sd">                * ``&quot;last&quot;``: Only read the VDF of the last time step</span>
<span class="sd">                * ``&quot;first&quot;``: Only read the VDF of the first time step</span>
<span class="sd">                * ``&quot;all&quot;``: Read a separate VDF for each time step.</span>
<span class="sd">                * ``list[int]``: Read VDF for each time step included in list.</span>
<span class="sd">                * ``int``: read VDF at one specific time step.</span>

<span class="sd">            sample_cap (int): Limit the number of samples read from the dump</span>
<span class="sd">                file for very large files. Default is 500000. If bool(sample_cap)</span>
<span class="sd">                evaluates to ``False``, then no cap will be imposed.</span>
<span class="sd">            bins (int): Total number of bins to divide the energy space into.</span>
<span class="sd">            maxwellian (bool): Option to draw a maxwellian distribution</span>
<span class="sd">                with the same temperature for comparison.</span>
<span class="sd">            save (str): Optional location of directory to save the figure in.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: stamp with temperature for species.</span>
        <span class="c1"># TODO: Add variable-width bins</span>
        <span class="c1"># TODO: Add symmetrical log plots.</span>
        <span class="c1"># TODO: Add option to choose between the above.</span>

        <span class="c1"># XXX: For now, it is assumed that only VDFs for electrons exist.</span>

        <span class="n">edfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_edfs</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">sample_cap</span><span class="o">=</span><span class="mi">500000</span><span class="p">)</span>
        <span class="c1"># Save pretty component names</span>
        <span class="n">xlabels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;$\e&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;psilon</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">$ (eV)&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="s2">&quot;_y&quot;</span><span class="p">,</span> <span class="s2">&quot;_z&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;_{\rm tot}&quot;</span><span class="p">]]</span>
        <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">edf</span> <span class="ow">in</span> <span class="n">edfs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">):</span>
            <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;Ex&quot;</span><span class="p">,</span> <span class="s2">&quot;Ey&quot;</span><span class="p">,</span> <span class="s2">&quot;Ez&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">],</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">())):</span>
                <span class="c1"># Get component series</span>
                <span class="n">edf_c</span> <span class="o">=</span> <span class="n">edf</span><span class="p">[</span><span class="n">comp</span><span class="o">+</span><span class="s2">&quot;_signed&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">comp</span> <span class="o">!=</span> <span class="s2">&quot;E&quot;</span> <span class="k">else</span> <span class="n">edf</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]</span>
                <span class="c1"># Plot the histogram</span>
                <span class="n">edf_c</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
                <span class="n">mean_e</span> <span class="o">=</span> <span class="n">edf</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">Ne</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edf</span><span class="p">)</span> <span class="c1"># Counts of particles</span>

                <span class="c1"># Create maxwellian plot</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">divs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">edf_c</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
                <span class="n">dE</span> <span class="o">=</span> <span class="n">divs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">divs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">centers</span> <span class="o">=</span> <span class="n">divs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dE</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">prefactor</span><span class="o">=</span><span class="mi">1</span>
                <span class="c1"># Mass of this species</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="p">[</span><span class="s2">&quot;MP&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">comp</span> <span class="o">==</span> <span class="s2">&quot;E&quot;</span><span class="p">:</span>
                    <span class="c1"># The speed distribution in units of energy</span>
                    <span class="n">maxwellian</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">Ne</span><span class="o">*</span><span class="n">dE</span> <span class="o">*</span> <span class="n">e</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">mean_e</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">mean_e</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># The 1D Gaussian velocity distribution in units of energy</span>
                    <span class="n">maxwellian</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">Ne</span><span class="o">*</span><span class="n">dE</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">mean_e</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">/</span><span class="n">mean_e</span><span class="p">)</span>
                <span class="n">maxw_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">maxwellian</span><span class="p">)(</span><span class="n">centers</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span> <span class="n">maxw_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Maxwellian&quot;</span><span class="p">)</span>

                <span class="c1"># View on a log scale</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">.9</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">.18</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">.15</span><span class="p">)</span>
            <span class="c1"># Label axes</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="n">sname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">save</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save</span><span class="p">)</span>
                <span class="n">saveas</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">sname</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">_edf.pdf&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving edf plots in </span><span class="si">{</span><span class="n">saveas</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveas</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figs</span><span class="p">,</span> <span class="n">steps</span></div>


<div class="viewcode-block" id="ThunderBoltz.plot_edfs"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.plot_edfs.html#pytb.ThunderBoltz.plot_edfs">[docs]</a>    <span class="k">def</span> <span class="nf">plot_edfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">sample_cap</span><span class="o">=</span><span class="mi">500000</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">plot_cs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the electron total energy distribution function, optionally</span>
<span class="sd">        include the provided cross sections for comparison.</span>

<span class="sd">        Args:</span>
<span class="sd">            steps (str, list[int], or int): Options for which time steps to</span>
<span class="sd">                read:</span>

<span class="sd">                * ``&quot;last&quot;``: Only read the VDF of the last time step</span>
<span class="sd">                * ``&quot;first&quot;``: Only read the VDF of the first time step</span>
<span class="sd">                * ``&quot;all&quot;``: Read a separate VDF for each time step.</span>
<span class="sd">                * ``list[int]``: Read VDF for each time step included in list.</span>
<span class="sd">                * ``int``: read VDF at one specific time step.</span>

<span class="sd">            sample_cap (int): Limit the number of samples read from the dump</span>
<span class="sd">                file for very large files. Default is 500000. If bool(sample_cap)</span>
<span class="sd">                evaluates to ``False``, then no cap will be imposed.</span>
<span class="sd">            bins (int): Total number of bins to divide the energy space into.</span>
<span class="sd">            maxwellian (bool): Option to draw a maxwellian distribution</span>
<span class="sd">                with the same temperature for comparison.</span>
<span class="sd">            save (bool): Optional location of directory to save the figure in.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (Tuple[list[matplotlib.figure.Figure], list[int]): The list of</span>
<span class="sd">            figures and a list of their corresponding step indices.</span>

<span class="sd">        Note:</span>
<span class="sd">            It currently assumed that only data for one particle type is to be</span>
<span class="sd">            plotted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">edfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_edfs</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">sample_cap</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">plot_cs</span><span class="p">:</span>
            <span class="c1"># Plot it on the right y-axes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">plot_cs</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">edfs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">):</span>
            <span class="n">vals</span><span class="p">,</span> <span class="n">divs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="n">de</span> <span class="o">=</span> <span class="n">divs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">divs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">evals</span> <span class="o">=</span> <span class="n">divs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">de</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">evals</span><span class="p">,</span> <span class="n">vals</span><span class="o">/</span><span class="n">de</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Particle number density (eV$^{-1}$)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy (eV)&quot;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></div>


<div class="viewcode-block" id="ThunderBoltz.plot_vdfs"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.plot_vdfs.html#pytb.ThunderBoltz.plot_vdfs">[docs]</a>    <span class="k">def</span> <span class="nf">plot_vdfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">sample_cap</span><span class="o">=</span><span class="mi">500000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the joint distribution heat map between the x-y and x-z</span>
<span class="sd">        velocities.</span>

<span class="sd">        Args:</span>
<span class="sd">            steps (str, list[int], or int): Options for which time steps to</span>
<span class="sd">                read:</span>

<span class="sd">                * ``&quot;last&quot;``: Only read the VDF of the last time step</span>
<span class="sd">                * ``&quot;first&quot;``: Only read the VDF of the first time step</span>
<span class="sd">                * ``&quot;all&quot;``: Read a separate VDF for each time step.</span>
<span class="sd">                * ``list[int]``: Read VDF for each time step included in list.</span>
<span class="sd">                * ``int``: read VDF at one specific time step.</span>

<span class="sd">            sample_cap (int): Limit the number of samples read from the dump</span>
<span class="sd">                file for very large files. Default is 500000. If bool(sample_cap)</span>
<span class="sd">                evaluates to ``False``, then no cap will be imposed.</span>
<span class="sd">            bins (int): Total number of bins to divide the energy space into.</span>
<span class="sd">            save (str): Optional location of directory to save the figure in.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (Tuple[list[matplotlib.figure.Figure], list[int]): The list of</span>
<span class="sd">            figures and a list of their corresponding step indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check whats available out of the requested</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_vdfs</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">sample_cap</span><span class="p">)</span>
        <span class="n">available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_available_vdfs</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
        <span class="c1"># Confine plots to only the requested</span>
        <span class="n">vdfs_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">available</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Loop through included vdf groups</span>
        <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">vdf</span> <span class="ow">in</span> <span class="n">vdfs_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">):</span>
            <span class="n">fig_xy</span> <span class="o">=</span> <span class="n">plot_vdfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="n">fig_xz</span> <span class="o">=</span> <span class="n">plot_vdfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="p">,</span> <span class="n">pair</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                <span class="n">sname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">save</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save</span><span class="p">)</span>
                <span class="n">saveas</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">sname</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;_xy</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving VDF joint plot in </span><span class="si">{</span><span class="n">saveas</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">fig_xy</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveas</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig_xy</span><span class="p">)</span>
                <span class="n">saveas</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">sname</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;_xz</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving VDF joint plot in </span><span class="si">{</span><span class="n">saveas</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">fig_xz</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveas</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig_xz</span><span class="p">)</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">fig_xy</span><span class="p">,</span> <span class="n">fig_xz</span><span class="p">])</span>
            <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">figs</span><span class="p">,</span> <span class="n">steps</span></div>

<div class="viewcode-block" id="ThunderBoltz.plot_cs"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.plot_cs.html#pytb.ThunderBoltz.plot_cs">[docs]</a>    <span class="k">def</span> <span class="nf">plot_cs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vsig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">thresholds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_args</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Plot the cross sections models.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax (:class:`~.matplotlib.axes.Axes` or None): Optional</span>
<span class="sd">                axes object to plot on top of, default is None.</span>
<span class="sd">                If ax is None, then a new figure and ax object</span>
<span class="sd">                will be created.</span>
<span class="sd">            legend (bool): Activate axes legend if true,</span>
<span class="sd">                default is True.</span>
<span class="sd">            vsig (bool): Plot :math:`\sqrt{\frac{2\epsilon}{m_{\rm e}}}\sigma(\epsilon)`</span>
<span class="sd">                rather than :math:`\sigma(\epsilon)`.</span>
<span class="sd">            thresholds (bool): if True, plot energy units in thresholds.</span>
<span class="sd">            save (str): Optional location of the directory to save the plot in.</span>
<span class="sd">            **plot_args: Optional arguments passed to Axes.plot().</span>
<span class="sd">        Returns:</span>
<span class="sd">            :class:`matplotlib.axes.Axes`: The axes object of the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">plot_cs</span><span class="p">(</span>
            <span class="n">ax</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">vsig</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">sname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">save</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save</span><span class="p">)</span>
            <span class="n">saveas</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">sname</span><span class="o">+</span><span class="s2">&quot;_cs.pdf&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving cross section plot in </span><span class="si">{</span><span class="n">saveas</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveas</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span></div>

    <span class="k">def</span> <span class="nf">_check_available_vdfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">get_types</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check what steps are available base on required criteria.&quot;&quot;&quot;</span>
        <span class="n">available</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># First, check directory for file data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">efile</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;Dump&quot;</span> <span class="ow">in</span> <span class="n">efile</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;_0_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">efile</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">available</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">efile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Then check for already parsed data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p0_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="o">.</span><span class="n">ptype</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">available</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span>
                <span class="n">available</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdfs</span><span class="p">[</span><span class="n">p0_only</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">available</span><span class="p">)</span> <span class="ow">or</span> <span class="n">steps</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">available</span> <span class="c1"># No data available</span>

        <span class="c1"># Choose which time steps to include based on `steps`</span>
        <span class="k">if</span> <span class="n">steps</span> <span class="o">==</span> <span class="s2">&quot;last&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">available</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">steps</span> <span class="o">==</span> <span class="s2">&quot;first&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">available</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">steps</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">available</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">steps</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">available</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_tabulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add params to DataFrame.&quot;&quot;&quot;</span>
        <span class="c1"># Log inputs into table format</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="c1"># Log meta params into table format</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write down the hyper parameters into a file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">directory</span><span class="p">:</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pjoin</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hp&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">,</span> <span class="s2">&quot;tb&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="p">,</span> <span class="s2">&quot;elapsed_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_time</span><span class="p">,</span>
                    <span class="s2">&quot;runtime_start&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_start</span><span class="p">,</span> <span class="s2">&quot;runtime_end&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_end</span><span class="p">}</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;indeck&quot;</span><span class="p">])</span>
            <span class="c1"># Convert functions to function names</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
                <span class="n">dat</span><span class="p">[</span><span class="s2">&quot;hp&quot;</span><span class="p">][</span><span class="s2">&quot;indeck&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="c1"># Convert any numpy/pandas datatypes into python primitives</span>
            <span class="n">to_primitive</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
            <span class="c1"># Serialize into log file</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="p">[</span><span class="s2">&quot;indeck&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>

<div class="viewcode-block" id="ThunderBoltz.to_pickleable"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.to_pickleable.html#pytb.ThunderBoltz.to_pickleable">[docs]</a>    <span class="k">def</span> <span class="nf">to_pickleable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a picklable version of this object.&quot;&quot;&quot;</span>
        <span class="c1"># It is currently entirely picklable</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ThunderBoltz.get_directory"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.get_directory.html#pytb.ThunderBoltz.get_directory">[docs]</a>    <span class="k">def</span> <span class="nf">get_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the path of the current simulation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span></div>

<div class="viewcode-block" id="ThunderBoltz.read_log"><a class="viewcode-back" href="../../api/pytb.ThunderBoltz.read_log.html#pytb.ThunderBoltz.read_log">[docs]</a>    <span class="k">def</span> <span class="nf">read_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logfile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read json file from simulation directory. Update</span>
<span class="sd">        the corresponding settings in the ThunderBoltz object.</span>

<span class="sd">        Args:</span>
<span class="sd">            logfile (str): The path name of the logfile to read.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lpath</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">logfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">lpath</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lpath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">dat</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s2">&quot;hp&quot;</span><span class="p">])</span> <span class="c1"># Update in case params added</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tb_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s2">&quot;tb&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s2">&quot;elapsed_time&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runtime_start</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s2">&quot;runtime_start&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">runtime_end</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s2">&quot;runtime_end&quot;</span><span class="p">]</span></div></div>

<div class="viewcode-block" id="read"><a class="viewcode-back" href="../../api/pytb.tb.read.html#pytb.read">[docs]</a><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">read_cs_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a ThunderBoltz object by reading from a</span>
<span class="sd">    ThunderBoltz simulation directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory (str): The directory from which to</span>
<span class="sd">            initialize the ThunderBoltz object.</span>
<span class="sd">        read_cs_data (bool):</span>
<span class="sd">            When set to true, the reader will look for cs_data,</span>
<span class="sd">            default is ``False``</span>

<span class="sd">    Returns:</span>
<span class="sd">        :class:`~.pytb.ThunderBoltz`: The ThunderBoltz object with</span>
<span class="sd">        tabulated data if available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">ThunderBoltz</span><span class="p">()</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">read_cs_data</span><span class="o">=</span><span class="n">read_cs_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tb</span></div>

<div class="viewcode-block" id="query_tree"><a class="viewcode-back" href="../../api/pytb.tb.query_tree.html#pytb.query_tree">[docs]</a><span class="k">def</span> <span class="nf">query_tree</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">name_req</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param_req</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">read_cs_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">agg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Walk a directory tree and search for ThunderBoltz</span>
<span class="sd">    simulation directories to read. Either return a list of</span>
<span class="sd">    :class:`~.pytb.ThunderBoltz` objects, or a custom aggregation of</span>
<span class="sd">    the output data.</span>

<span class="sd">    Args:</span>
<span class="sd">        directory (str): The root path to search for ThunderBoltz</span>
<span class="sd">            data in.</span>

<span class="sd">        name_req (callable[str,bool]): A requirement on the file path</span>
<span class="sd">            names to be included in the query. The callable accepts</span>
<span class="sd">            the file path of a thunderboltz simulation directory and</span>
<span class="sd">            should return ``True`` if that directory is to be included</span>
<span class="sd">            in the query.</span>

<span class="sd">            e.g. ``name_req=lambda s: &quot;test_type_1&quot; in s``</span>
<span class="sd">            would return only data in a subfolder ``test_type_1``.</span>

<span class="sd">        param_req (dict): A requirement on the</span>
<span class="sd">            parameter settings of the ThunderBoltz calculations.</span>
<span class="sd">            The dictionary corresponding to simulation parameters</span>
<span class="sd">            that must be set by the read ThunderBoltz object.</span>

<span class="sd">            e.g. ``param_req={&quot;Ered&quot;: 100, &quot;L&quot;: 1e-6}`` would only</span>
<span class="sd">            return data from calculations with a reduced field of</span>
<span class="sd">            100 Td and a cell length of 1 :math:`\mu{\rm m}`.</span>

<span class="sd">        callback: (callable[:class:`ThunderBoltz`, Any]):</span>
<span class="sd">            A function that accepts a ThunderBoltz object and</span>
<span class="sd">            returns the desired data.</span>

<span class="sd">        agg: If ``callback`` is set, attempt to aggregate the data</span>
<span class="sd">            based on the data type:</span>

<span class="sd">            ===============================   ============================</span>
<span class="sd">            callback Return Type              Behavior</span>
<span class="sd">            ===============================   ============================</span>
<span class="sd">            :class:`pandas.DataFrame`         Frames will be</span>
<span class="sd">                                              concatenated row-wise and</span>
<span class="sd">                                              one larger DataFrame will be</span>
<span class="sd">                                              returned.</span>

<span class="sd">            list[:class:`pandas.DataFrame`]   A list of frames the same</span>
<span class="sd">                                              length of the return value</span>
<span class="sd">                                              will be returned. The frame</span>
<span class="sd">                                              at index ``i`` will contain</span>
<span class="sd">                                              the concatenated data</span>
<span class="sd">                                              from each simulation returned</span>
<span class="sd">                                              by ``callable(tb)[i]``.</span>

<span class="sd">            list[Any]                         A list of lists will be</span>
<span class="sd">                                              returned. The list at index</span>
<span class="sd">                                              ``i`` will contain a list</span>
<span class="sd">                                              of items returned from each</span>
<span class="sd">                                              call to ``callable(tb)[i]``.</span>

<span class="sd">            Any                               Return values will be</span>
<span class="sd">                                              returned in a list.</span>
<span class="sd">            ===============================   ============================</span>

<span class="sd">            If ``agg`` is set to False, always return a list of callback data</span>
<span class="sd">            without any concatenation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[:class:`ThunderBoltz`], or :class:`pandas.DataFrame`, or list[:class:`pandas.DataFrame`], or list[list[Any]]:</span>
<span class="sd">        See ``agg`` option for behavior. Default return type</span>
<span class="sd">        is list[:class:`ThunderBoltz`].</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tbs</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># For return type 1</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> <span class="c1"># For return type 2</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># For return type 3</span>
    <span class="n">tb_dat</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># For return type 4</span>
    <span class="c1"># Default return type is list of TB objects</span>
    <span class="n">rtype</span> <span class="o">=</span> <span class="n">tbs</span>
    <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="c1"># Ensure this is a ThunderBoltz directory</span>
        <span class="k">if</span> <span class="s2">&quot;cross_sections&quot;</span> <span class="ow">in</span> <span class="n">dirs</span> <span class="ow">and</span> <span class="s2">&quot;thunderboltz.out&quot;</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="c1"># Ensure file path is matches requirements</span>
            <span class="k">if</span> <span class="n">name_req</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name_req</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">continue</span>

            <span class="c1"># Read in data for this ThunderBoltz obj.</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">read_cs_data</span><span class="o">=</span><span class="n">read_cs_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param_req</span><span class="p">:</span>
                <span class="n">valid_params</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">param_req</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">set_val</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">get_sim_param</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">valid_params</span> <span class="o">=</span> <span class="p">(</span><span class="n">set_val</span> <span class="o">==</span> <span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="n">valid_params</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_params</span><span class="p">:</span> <span class="k">continue</span>

            <span class="c1"># Append object once determined to be included</span>
            <span class="n">tbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>

            <span class="c1"># If desired, extract data from ThunderBoltz objects.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callback</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="n">agg</span><span class="p">:</span>
                <span class="c1"># Build one big data frame with all the data</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">df</span><span class="p">,</span> <span class="n">dat</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">rtype</span> <span class="o">=</span> <span class="n">df</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="c1"># Build a list of either lists or DataFrames</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
                <span class="n">is_df_list</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">)</span>

                <span class="c1"># Initialize if necessary</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">):</span> <span class="n">dfs</span> <span class="o">=</span> <span class="n">n</span><span class="o">*</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">tb_dat</span><span class="p">):</span> <span class="n">tb_dat</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dat</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">is_df_list</span> <span class="ow">and</span> <span class="n">agg</span><span class="p">:</span>
                        <span class="n">dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">dfs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">item</span><span class="p">),</span>
                            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">rtype</span> <span class="o">=</span> <span class="n">dfs</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tb_dat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="n">rtype</span> <span class="o">=</span> <span class="n">tb_dat</span>
            <span class="c1"># Otherwise just return the list of ThunderBoltz objects</span>

    <span class="c1"># Return the correct datatype</span>
    <span class="k">return</span> <span class="n">rtype</span></div>

<span class="k">def</span> <span class="nf">to_primitive</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recursively convert collections with non primitive types</span>
<span class="sd">    back to python natives.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">iterable</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">iterable</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># Recurse mutable collections in place</span>
            <span class="n">to_primitive</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">infer_param_type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">infer_param_type</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sequential type checking for parameter io.&quot;&quot;&quot;</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">t</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No type satisfied by </span><span class="si">{x}</span><span class="s2">&quot;</span><span class="p">)</span>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, Ryan Park
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    </body>
</html>